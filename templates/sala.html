<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala {{ codigo_sala }} - SyncMusic</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='src/guia.png') }}" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="player-body">
    <!-- Header/Navbar -->
    <header class="player-header">
        <div class="header-left">
            <div class="logo-container">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
                <span class="logo-text">Sala {{ codigo_sala }}</span>
            </div>
        </div>
        
        <div class="header-center">
            <div class="status-badges">
                {% if is_host %}
                    <span class="badge badge-host">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Voc√™ √© o Host
                    </span>
                {% else %}
                    <span class="badge badge-listener">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
                        </svg>
                        Ouvinte
                    </span>
                {% endif %}
                
                <span class="badge badge-users">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2.996 2.996 0 0 0 17.06 7c-.8 0-1.54.5-1.85 1.26l-1.92 5.77A2 2 0 0 0 15.18 16H16v6h4zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2.5 16v-7H9.5l-.68-2.04A2.02 2.02 0 0 0 6.9 11.5c-.8 0-1.54.5-1.85 1.26l-1.92 5.77c-.24.72.16 1.47.9 1.47H8v2.5c0 .28.22.5.5.5h2c.28 0 .5-.22.5-.5z"/>
                    </svg>
                    <span id="total-participantes">1</span> online
                </span>
            </div>
        </div>
        
        <div class="header-right">
            <a href="{{ url_for('index') }}" class="btn-exit">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                </svg>
                Sair da Sala
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="player-main">
        <!-- Left Panel - Now Playing -->
        <section class="now-playing-panel">
            <div id="reprodutor" style="display: none;"></div>
            
            <!-- Album Art / Video Thumbnail -->
            <div class="album-art-container">
                <div id="sem-video" class="album-art-placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                </div>
                <div class="container-miniatura" style="display: none;"></div>
            </div>
            
            <!-- Track Info -->
            <div class="track-info">
                <h1 id="track-title" class="track-title">Nenhuma m√∫sica selecionada</h1>
                <p id="track-artist" class="track-artist">Clique em ‚ûï para adicionar a primeira m√∫sica!</p>
                
                {% if is_host %}
                <button id="btn-add-first-music" class="btn-add-first" onclick="document.getElementById('add-music-modal').style.display = 'flex'">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Adicionar Primeira M√∫sica
                </button>
                {% endif %}
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-section">
                <span class="time-current" id="tempo-display">0:00</span>
                <div class="progress-track">
                    <div class="progress-fill-track" id="progress-fill"></div>
                </div>
                <span class="time-total" id="tempo-total">0:00</span>
            </div>
            
            <!-- Player Controls -->
            <div class="player-controls">
                {% if is_host %}
                <button id="video-anterior" class="control-btn" title="Anterior">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                    </svg>
                </button>
                
                <button id="tocar" class="control-btn control-btn-main" title="Tocar">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                
                <button id="pausar" class="control-btn control-btn-main" title="Pausar" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>
                </button>
                
                <button id="proximo-video" class="control-btn" title="Pr√≥ximo">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                    </svg>
                </button>
                {% else %}
                <div class="listener-info">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
                    </svg>
                    <span>Controles dispon√≠veis apenas para o host</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Status Info -->
            <div id="status-reproducao" class="status-display">
                <span id="status-icon">‚è∏Ô∏è</span>
                <span id="status-text">Pausado</span>
            </div>
        </section>
        
        <!-- Right Panel - Playlist -->
        <section class="playlist-panel">
            <div class="playlist-header">
                <div class="playlist-title">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                    </svg>
                    Playlist
                </div>
                
                {% if is_host %}
                <div class="playlist-actions">
                    <button id="btn-add-music" class="btn-playlist-action" title="Adicionar m√∫sica">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
            
            <div class="playlist-content">
                <div id="miniaturas-playlist" class="playlist-items">
                    <div class="playlist-empty">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p>Nenhuma m√∫sica na playlist</p>
                        {% if is_host %}
                        <p class="playlist-hint">Clique em ‚ûï para adicionar a primeira m√∫sica!</p>
                        {% endif %}
                    </div>
                </div>
                
                <div id="controles-paginacao" class="playlist-pagination" style="display: none;">
                    <button id="pagina-anterior" class="pagination-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    <button id="proxima-pagina" class="pagination-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Add Music Modal (Host only) -->
    {% if is_host %}
    <div id="add-music-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar M√∫sica</h3>
                <button id="close-modal" class="btn-close">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="input-group-modal">
                    <label for="url-video">Link do YouTube</label>
                    <input type="text" id="url-video" placeholder="Cole aqui o link do v√≠deo ou playlist">
                </div>
                
                <div class="modal-actions">
                    <button id="carregar-video" class="btn-modal btn-primary">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                        Adicionar M√∫sica
                    </button>
                    <button id="carregar-playlist" class="btn-modal btn-secondary">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                        </svg>
                        Importar Playlist
                    </button>
                </div>
                
                <div id="playlist-progress" class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span class="progress-text">Carregando playlist...</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Configura√ß√µes globais
        const CODIGO_SALA = '{{ codigo_sala }}';
        const IS_HOST = {{ is_host|tojson }};
        
        // Vari√°veis do player
        let player;
        let socket;
        let playlist = [];
        let indiceVideoAtual = -1;
        let paginaAtual = 0;
        
        // Fun√ß√£o para determinar quantos v√≠deos por p√°gina baseado no tamanho da tela
        function getVideosPorPagina() {
            return window.innerWidth <= 768 ? 4 : 6; // Mobile: 4, Desktop: 6
        }
        let sincronizandoTempo = false;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSocket();
        });
        
        // Recalcula pagina√ß√£o quando a tela √© redimensionada
        window.addEventListener('resize', function() {
            if (playlist.length > 0) {
                paginaAtual = 0; // Reseta para primeira p√°gina
                atualizarPlaylist();
            }
        });
        
        // Socket.IO
        function inicializarSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Conectado ao servidor');
                socket.emit('conectar_sala', {
                    codigo_sala: CODIGO_SALA,
                    is_host: IS_HOST
                });
            });
            
            socket.on('estado_sala', function(data) {
                console.log('Estado da sala recebido:', data);
                playlist = data.playlist || [];
                indiceVideoAtual = data.indice_atual || -1;
                
                atualizarPlaylist();
                atualizarInfoMusicaAtual();
                
                if (data.video_atual) {
                    // Se est√° tocando, carrega e toca automaticamente
                    configurarPlayer(data.video_atual, data.tempo_atual || 0, data.tocando || false);
                    
                    // Se deve estar tocando, for√ßa o play ap√≥s carregar
                    if (data.tocando) {
                        setTimeout(() => {
                            if (player && player.playVideo) {
                                console.log('For√ßando play do v√≠deo (estado da sala)');
                                player.playVideo();
                            }
                        }, 2000);
                    }
                }
            });
            
            socket.on('playlist_atualizada', function(data) {
                console.log('Playlist atualizada:', data);
                const playlistAnterior = playlist.length;
                playlist = data.playlist;
                indiceVideoAtual = data.indice_atual;
                atualizarPlaylist();
                atualizarInfoMusicaAtual();
                
                if (data.video_atual) {
                    // Verifica se √© um v√≠deo diferente ou se n√£o h√° player
                    const videoAtualId = player && player.getVideoData ? player.getVideoData().video_id : null;
                    if (!player || videoAtualId !== data.video_atual) {
                        console.log('Carregando novo v√≠deo da playlist:', data.video_atual);
                        
                        // Se √© o primeiro v√≠deo adicionado (individual ou playlist) e somos o host, come√ßa automaticamente
                        const isFirstVideo = (playlistAnterior === 0 && playlist.length >= 1 && IS_HOST);
                        configurarPlayer(data.video_atual, 0, isFirstVideo);
                        
                        // Se √© o primeiro v√≠deo e somos host, emite comando para tocar
                        if (isFirstVideo) {
                            setTimeout(() => {
                                console.log('Iniciando reprodu√ß√£o do primeiro v√≠deo automaticamente (playlist ou individual)');
                                socket.emit('tocar_video', { codigo_sala: CODIGO_SALA });
                            }, 2000);
                        }
                    }
                }
            });
            
            socket.on('video_tocando', function(data) {
                console.log('V√≠deo tocando:', data);
                atualizarStatusReproducao('‚ñ∂Ô∏è', 'Tocando');
                alternarBotoesPlayPause(true);
                
                if (player && player.playVideo) {
                    sincronizandoTempo = true;
                    
                    // Sincroniza tempo primeiro
                    if (data.tempo_atual) {
                        player.seekTo(data.tempo_atual, true);
                    }
                    
                    // Tenta tocar com retry
                    const tentarPlay = () => {
                        player.playVideo();
                        
                        // Verifica se realmente est√° tocando ap√≥s 1 segundo
                        setTimeout(() => {
                            if (player.getPlayerState() !== YT.PlayerState.PLAYING) {
                                console.log('V√≠deo n√£o est√° tocando, tentando novamente...');
                                atualizarStatusReproducao('‚ö†Ô∏è', 'Clique em ‚ñ∂Ô∏è para tocar');
                                alternarBotoesPlayPause(false);
                                player.playVideo();
                            } else {
                                atualizarStatusReproducao('‚ñ∂Ô∏è', 'Tocando');
                                alternarBotoesPlayPause(true);
                            }
                        }, 1000);
                    };
                    
                    tentarPlay();
                    setTimeout(() => { sincronizandoTempo = false; }, 2000);
                }
            });
            
            socket.on('video_pausado', function(data) {
                console.log('V√≠deo pausado:', data);
                atualizarStatusReproducao('‚è∏Ô∏è', 'Pausado');
                alternarBotoesPlayPause(false);
                
                if (player && player.pauseVideo) {
                    sincronizandoTempo = true;
                    if (data.tempo_atual) {
                        player.seekTo(data.tempo_atual, true);
                    }
                    player.pauseVideo();
                    setTimeout(() => { sincronizandoTempo = false; }, 1000);
                }
            });
            
            socket.on('video_alterado', function(data) {
                console.log('V√≠deo alterado:', data);
                indiceVideoAtual = data.indice_atual;
                configurarPlayer(data.video_atual, data.tempo_atual || 0, false);
                atualizarPlaylist();
                atualizarInfoMusicaAtual();
                
                // Auto-inicia a pr√≥xima m√∫sica se somos o host
                if (IS_HOST) {
                    setTimeout(() => {
                        console.log('Auto-iniciando pr√≥xima m√∫sica');
                        socket.emit('tocar_video', { codigo_sala: CODIGO_SALA });
                    }, 2000);
                }
            });
            
            socket.on('participante_conectou', function(data) {
                document.getElementById('total-participantes').textContent = data.total_participantes;
            });
            
            socket.on('participante_desconectou', function(data) {
                document.getElementById('total-participantes').textContent = data.total_participantes;
            });
            
            socket.on('novo_host', function(data) {
                if (data.novo_host) {
                    location.reload(); // Recarrega para atualizar interface de host
                }
            });
            
            socket.on('erro', function(data) {
                alert('Erro: ' + data.mensagem);
            });
        }
        
        // Fun√ß√£o para atualizar status visual
        function atualizarStatusReproducao(icone, texto) {
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            
            if (statusIcon && statusText) {
                statusIcon.textContent = icone;
                statusText.textContent = texto;
            }
        }
        
        // Fun√ß√£o para alternar bot√µes play/pause
        function alternarBotoesPlayPause(tocando) {
            const btnTocar = document.getElementById('tocar');
            const btnPausar = document.getElementById('pausar');
            
            if (tocando) {
                if (btnTocar) btnTocar.style.display = 'none';
                if (btnPausar) btnPausar.style.display = 'flex';
            } else {
                if (btnTocar) btnTocar.style.display = 'flex';
                if (btnPausar) btnPausar.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para atualizar informa√ß√µes da m√∫sica atual
        function atualizarInfoMusicaAtual() {
            console.log('Atualizando info da m√∫sica atual:', { playlist: playlist.length, indice: indiceVideoAtual });
            
            if (playlist.length > 0 && indiceVideoAtual >= 0 && indiceVideoAtual < playlist.length) {
                const videoAtual = playlist[indiceVideoAtual];
                console.log('V√≠deo atual:', videoAtual);
                
                // Esconde bot√£o de adicionar primeira m√∫sica
                const btnAddFirst = document.getElementById('btn-add-first-music');
                if (btnAddFirst) btnAddFirst.style.display = 'none';
                
                // Atualiza miniatura
                document.getElementById('sem-video').style.display = 'none';
                const containerMiniatura = document.querySelector('.container-miniatura');
                containerMiniatura.style.display = 'block';
                containerMiniatura.innerHTML = `<img src="https://img.youtube.com/vi/${videoAtual}/hqdefault.jpg" alt="Miniatura">`;
                
                // Busca t√≠tulo do v√≠deo via API do YouTube (t√≠tulo b√°sico)
                fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoAtual}&format=json`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dados do v√≠deo recebidos:', data);
                        document.getElementById('track-title').textContent = data.title || 'M√∫sica Atual';
                        document.getElementById('track-artist').textContent = data.author_name || 'YouTube';
                    })
                    .catch((error) => {
                        console.log('Erro ao buscar dados do v√≠deo:', error);
                        document.getElementById('track-title').textContent = 'M√∫sica Atual';
                        document.getElementById('track-artist').textContent = 'YouTube';
                    });
            } else {
                console.log('Nenhuma m√∫sica para mostrar');
                // Mostra bot√£o de adicionar primeira m√∫sica
                const btnAddFirst = document.getElementById('btn-add-first-music');
                if (btnAddFirst) btnAddFirst.style.display = 'flex';
                
                // Reseta para estado vazio
                document.getElementById('track-title').textContent = 'Nenhuma m√∫sica selecionada';
                document.getElementById('track-artist').textContent = 'Clique em ‚ûï para adicionar a primeira m√∫sica!';
                document.getElementById('sem-video').style.display = 'flex';
                document.querySelector('.container-miniatura').style.display = 'none';
            }
        }
        
        // YouTube API
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API carregada');
        }
        
        function aoPlayerPronto(event) {
            console.log('Player pronto - Estado:', player.getPlayerState());
            console.log('V√≠deo carregado:', player.getVideoData());
            
            // Atualiza tempo a cada segundo
            setInterval(function() {
                if (player && player.getCurrentTime && !sincronizandoTempo) {
                    var tempoAtual = player.getCurrentTime();
                    document.getElementById('tempo-display').textContent = formatarTempo(Math.floor(tempoAtual));
                    
                    // Host sincroniza tempo periodicamente
                    if (IS_HOST && player.getPlayerState() === YT.PlayerState.PLAYING) {
                        socket.emit('sincronizar_tempo', {
                            codigo_sala: CODIGO_SALA,
                            tempo_atual: tempoAtual
                        });
                    }
                }
            }, 1000);
            
            // Event listeners apenas para host
            if (IS_HOST) {
                document.getElementById('tocar').addEventListener('click', function() {
                    console.log('Bot√£o tocar clicado pelo host');
                    if (player && player.playVideo) {
                        // Toca localmente primeiro para ativar o player
                        try {
                            player.playVideo();
                            console.log('Comando playVideo() enviado');
                        } catch (error) {
                            console.error('Erro ao tocar:', error);
                        }
                    } else {
                        console.error('Player n√£o dispon√≠vel');
                    }
                    // Depois emite para todos
                    socket.emit('tocar_video', { codigo_sala: CODIGO_SALA });
                });
                
                document.getElementById('pausar').addEventListener('click', function() {
                    const tempo = player.getCurrentTime();
                    socket.emit('pausar_video', { 
                        codigo_sala: CODIGO_SALA,
                        tempo_atual: tempo
                    });
                });
                
                document.getElementById('parar').addEventListener('click', function() {
                    socket.emit('pausar_video', { 
                        codigo_sala: CODIGO_SALA,
                        tempo_atual: 0
                    });
                });
            }
        }
        
        function aoAlterarEstadoPlayer(event) {
            console.log('Estado do player alterado:', event.data);
            
            if (event.data === YT.PlayerState.ENDED && IS_HOST) {
                console.log('M√∫sica terminou, pulando para pr√≥xima');
                // Auto-skip para pr√≥xima m√∫sica
                socket.emit('pular_video', { codigo_sala: CODIGO_SALA });
            }
            
            // Atualiza status visual e bot√µes baseado no estado
            switch(event.data) {
                case YT.PlayerState.PLAYING:
                    atualizarStatusReproducao('‚ñ∂Ô∏è', 'Tocando');
                    alternarBotoesPlayPause(true);
                    break;
                case YT.PlayerState.PAUSED:
                    atualizarStatusReproducao('‚è∏Ô∏è', 'Pausado');
                    alternarBotoesPlayPause(false);
                    break;
                case YT.PlayerState.BUFFERING:
                    atualizarStatusReproducao('‚è≥', 'Carregando...');
                    break;
                case YT.PlayerState.CUED:
                    atualizarStatusReproducao('‚è∏Ô∏è', 'Pronto para tocar');
                    alternarBotoesPlayPause(false);
                    break;
                case YT.PlayerState.ENDED:
                    atualizarStatusReproducao('‚èπÔ∏è', 'Finalizado');
                    alternarBotoesPlayPause(false);
                    break;
            }
        }
        
        function extrairIdVideo(url) {
            const match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|.+\?v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            const videoId = match ? match[1] : null;
            
            if (videoId) {
                console.log('ID extra√≠do:', videoId, 'da URL:', url);
            } else {
                console.error('N√£o foi poss√≠vel extrair ID da URL:', url);
            }
            
            return videoId;
        }
        
        function extrairIdPlaylist(url) {
            const match = url.match(/[?&]list=([^&]+)/);
            const playlistId = match ? match[1] : null;
            
            if (playlistId) {
                console.log('ID da playlist extra√≠do:', playlistId, 'da URL:', url);
            }
            
            return playlistId;
        }
        
        function isPlaylistUrl(url) {
            // Verifica se √© uma playlist real (n√£o radio ou mix)
            if (url.includes('playlist?list=')) {
                return true;
            }
            
            // Se tem &list= mas tamb√©m tem watch?v=, verifica se n√£o √© radio/mix
            if (url.includes('&list=') && url.includes('watch?v=')) {
                // Extrai o ID da lista
                const listMatch = url.match(/[?&]list=([^&]+)/);
                if (listMatch) {
                    const listId = listMatch[1];
                    // Radio playlists come√ßam com RD, Mix com RDMM, etc.
                    if (listId.startsWith('RD') || listId.startsWith('RDMM') || listId.startsWith('RDAMVM')) {
                        return false; // √â radio/mix, n√£o playlist real
                    }
                    return true; // √â playlist real
                }
            }
            
            return false;
        }
        
        async function importarPlaylist(playlistId) {
            const progressContainer = document.getElementById('playlist-progress');
            const progressFill = progressContainer.querySelector('.progress-fill');
            const progressText = progressContainer.querySelector('.progress-text');
            
            // Mostra barra de progresso
            progressContainer.style.display = 'block';
            progressText.textContent = 'Processando playlist...';
            progressFill.style.width = '20%';
            
            try {
                // M√©todo 1: Tentar com servidor backend
                progressText.textContent = 'Enviando playlist para o servidor...';
                progressFill.style.width = '40%';
                
                socket.emit('importar_playlist', {
                    codigo_sala: CODIGO_SALA,
                    playlist_id: playlistId
                });
                
                // Vari√°vel para controlar timeout
                let timeoutId;
                let resolvido = false;
                
                // Aguarda resposta do servidor
                socket.once('playlist_importada', function(data) {
                    if (resolvido) return;
                    resolvido = true;
                    clearTimeout(timeoutId);
                    
                    if (data.sucesso) {
                        progressFill.style.width = '100%';
                        progressText.textContent = `‚úÖ ${data.total_videos} m√∫sicas adicionadas com sucesso!`;
                        
                        // Se √© a primeira playlist e somos host, inicia automaticamente
                        if (playlist.length === 0 && IS_HOST) {
                            setTimeout(() => {
                                console.log('Iniciando primeira m√∫sica da playlist automaticamente');
                                socket.emit('tocar_video', { codigo_sala: CODIGO_SALA });
                            }, 2000);
                        }
                        
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 3000);
                    } else {
                        throw new Error(data.erro || 'Erro desconhecido');
                    }
                });
                
                socket.once('playlist_erro', function(data) {
                    if (resolvido) return;
                    resolvido = true;
                    clearTimeout(timeoutId);
                    throw new Error(data.mensagem || 'Erro ao processar playlist');
                });
                
                // Timeout de 30 segundos
                timeoutId = setTimeout(() => {
                    if (resolvido) return;
                    resolvido = true;
                    throw new Error('Timeout - playlist muito grande ou servidor ocupado');
                }, 30000);
                
            } catch (error) {
                console.error('Erro ao importar playlist:', error);
                
                // Fallback: m√©todo manual
                progressText.textContent = 'Tentando m√©todo alternativo...';
                progressFill.style.width = '60%';
                
                try {
                    await importarPlaylistManual(playlistId, progressContainer, progressFill, progressText);
                } catch (fallbackError) {
                    console.error('Erro no fallback:', fallbackError);
                    progressText.textContent = '‚ùå Erro ao importar playlist';
                    progressFill.style.width = '100%';
                    progressFill.style.backgroundColor = '#ef4444';
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressFill.style.backgroundColor = '#8b5cf6';
                    }, 3000);
                    
                    alert('N√£o foi poss√≠vel importar a playlist automaticamente.\n\nDicas:\n1. Verifique se a playlist √© p√∫blica\n2. Tente adicionar os v√≠deos individualmente\n3. Use playlists menores (at√© 20 v√≠deos)');
                }
            }
        }
        
        async function importarPlaylistManual(playlistId, progressContainer, progressFill, progressText) {
            // M√©todo manual: pede para o usu√°rio colar os links
            const resposta = confirm(
                'Importa√ß√£o autom√°tica falhou.\n\n' +
                'Deseja tentar o m√©todo manual?\n\n' +
                '1. Abra a playlist no YouTube\n' +
                '2. Copie os links dos v√≠deos\n' +
                '3. Cole um por vez no campo de entrada\n\n' +
                'Clique OK para continuar ou Cancelar para desistir.'
            );
            
            if (!resposta) {
                throw new Error('Importa√ß√£o cancelada pelo usu√°rio');
            }
            
            progressText.textContent = 'üìã Use o m√©todo manual - cole os links individualmente';
            progressFill.style.width = '100%';
            progressFill.style.backgroundColor = '#f59e0b';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressFill.style.backgroundColor = '#8b5cf6';
                
                // Foca no campo de entrada
                document.getElementById('url-video').focus();
                document.getElementById('url-video').placeholder = 'Cole aqui os links dos v√≠deos da playlist, um por vez';
            }, 4000);
        }
        
        function extrairVideosDePlaylist(htmlContent) {
            // Regex para extrair IDs de v√≠deo do HTML da playlist
            const videoIdRegex = /"videoId":"([a-zA-Z0-9_-]{11})"/g;
            const videoIds = [];
            let match;
            
            while ((match = videoIdRegex.exec(htmlContent)) !== null) {
                const videoId = match[1];
                if (!videoIds.includes(videoId)) {
                    videoIds.push(videoId);
                }
            }
            
            return videoIds;
        }
        
        function validarVideoId(videoId) {
            // Verifica se tem exatamente 11 caracteres e cont√©m apenas caracteres v√°lidos
            const regex = /^[a-zA-Z0-9_-]{11}$/;
            return regex.test(videoId);
        }
        
        function formatarTempo(segundos) {
            const minutos = Math.floor(segundos / 60);
            const seg = Math.floor(segundos % 60);
            return `${minutos}:${seg < 10 ? '0' : ''}${seg}`;
        }
        
        function configurarPlayer(idVideo, tempoInicial = 0, autoplay = false) {
            console.log('Configurando player:', idVideo, tempoInicial, autoplay);
            
            const urlMiniatura = `https://img.youtube.com/vi/${idVideo}/hqdefault.jpg`;
            const imagemMiniatura = document.createElement('img');
            imagemMiniatura.src = urlMiniatura;
            imagemMiniatura.className = 'thumbnail-image';
            
            const containerMiniatura = document.querySelector('.container-miniatura');
            containerMiniatura.innerHTML = '';
            containerMiniatura.appendChild(imagemMiniatura);
            
            if (player && player.loadVideoById) {
                console.log('Carregando novo v√≠deo no player existente');
                player.loadVideoById({
                    videoId: idVideo,
                    startSeconds: tempoInicial
                });
                
                // Se n√£o √© autoplay, pausa ap√≥s carregar
                if (!autoplay) {
                    setTimeout(() => {
                        if (player && player.pauseVideo) {
                            player.pauseVideo();
                        }
                    }, 1000);
                }
            } else {
                console.log('Criando novo player');
                player = new YT.Player('reprodutor', {
                    height: '360',
                    width: '640',
                    videoId: idVideo,
                    playerVars: { 
                        'autoplay': 0, // Sempre 0 para evitar bloqueio
                        'controls': 0,
                        'disablekb': 1,
                        'fs': 0,
                        'iv_load_policy': 3,
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0,
                        'start': Math.floor(tempoInicial)
                    },
                    events: {
                        'onReady': function(event) {
                            console.log('Player criado e pronto');
                            aoPlayerPronto(event);
                            
                            // Se deve tocar automaticamente
                            if (autoplay) {
                                setTimeout(() => {
                                    if (player && player.playVideo) {
                                        console.log('Tentando autoplay...');
                                        player.playVideo();
                                    }
                                }, 1000);
                            }
                            
                            // Se tem tempo inicial, vai para a posi√ß√£o
                            if (tempoInicial > 0) {
                                setTimeout(() => {
                                    if (player && player.seekTo) {
                                        console.log('Sincronizando tempo inicial:', tempoInicial);
                                        player.seekTo(tempoInicial, true);
                                    }
                                }, 1500);
                            }
                        },
                        'onStateChange': aoAlterarEstadoPlayer,
                        'onError': function(event) {
                            console.error('Erro no player:', event.data);
                            let mensagemErro = 'Erro ao carregar o v√≠deo: ';
                            
                            switch(event.data) {
                                case 2:
                                    mensagemErro += 'ID do v√≠deo inv√°lido';
                                    break;
                                case 5:
                                    mensagemErro += 'Erro de HTML5 player';
                                    break;
                                case 100:
                                    mensagemErro += 'V√≠deo n√£o encontrado ou removido';
                                    break;
                                case 101:
                                case 150:
                                    mensagemErro += 'V√≠deo restrito pelo propriet√°rio (n√£o pode ser reproduzido em players externos)';
                                    break;
                                default:
                                    mensagemErro += 'Erro desconhecido (' + event.data + ')';
                            }
                            
                            alert(mensagemErro + '\n\nTente outro v√≠deo ou verifique se o link est√° correto.');
                            
                            // Se for host, remove o v√≠deo da playlist
                            if (IS_HOST && playlist.length > 0) {
                                console.log('Removendo v√≠deo com erro da playlist');
                                
                                // Remove o v√≠deo atual da playlist
                                const videoComErro = player.getVideoData().video_id;
                                socket.emit('remover_video', {
                                    codigo_sala: CODIGO_SALA,
                                    video_id: videoComErro
                                });
                            }
                        }
                    }
                });
            }
        }
        
        function atualizarPlaylist() {
            const containerPlaylist = document.getElementById('miniaturas-playlist');
            
            if (playlist.length === 0) {
                containerPlaylist.innerHTML = `
                    <div class="playlist-empty">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p>Nenhuma m√∫sica na playlist</p>
                    </div>
                `;
                
                // Mostra bot√£o de adicionar primeira m√∫sica
                const btnAddFirst = document.getElementById('btn-add-first-music');
                if (btnAddFirst) btnAddFirst.style.display = 'flex';
                
                // Reseta informa√ß√µes da m√∫sica
                document.getElementById('track-title').textContent = 'Nenhuma m√∫sica selecionada';
                document.getElementById('track-artist').textContent = 'Clique em para adicionar a primeira m√∫sica!';
                document.getElementById('sem-video').style.display = 'flex';
                document.querySelector('.container-miniatura').style.display = 'none';
                
                return;
            }
            
            // Esconde bot√£o de adicionar primeira m√∫sica
            const btnAddFirst = document.getElementById('btn-add-first-music');
            if (btnAddFirst) btnAddFirst.style.display = 'none';
            
            containerPlaylist.innerHTML = '';
            document.getElementById('controles-paginacao').style.display = 'flex';
            const videosPorPagina = getVideosPorPagina();
            const inicio = paginaAtual * videosPorPagina;
            const fim = inicio + videosPorPagina;
            
            playlist.slice(inicio, fim).forEach((idVideo, index) => {
                const urlMiniatura = `https://img.youtube.com/vi/${idVideo}/hqdefault.jpg`;
                
                // Cria item da playlist moderno
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                if (inicio + index === indiceVideoAtual) {
                    playlistItem.classList.add('active');
                }
                
                // Thumbnail
                const thumbnail = document.createElement('div');
                thumbnail.className = 'playlist-item-thumbnail';
                thumbnail.innerHTML = `<img src="${urlMiniatura}" alt="Thumbnail">`;
                
                // Info da m√∫sica
                const info = document.createElement('div');
                info.className = 'playlist-item-info';
                info.innerHTML = `
                    <div class="playlist-item-title">Carregando...</div>
                    <div class="playlist-item-duration">YouTube</div>
                `;
                
                // Busca nome real da m√∫sica
                fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${idVideo}&format=json`)
                    .then(response => response.json())
                    .then(data => {
                        const titleElement = info.querySelector('.playlist-item-title');
                        const durationElement = info.querySelector('.playlist-item-duration');
                        titleElement.textContent = data.title || `M√∫sica ${inicio + index + 1}`;
                        durationElement.textContent = data.author_name || 'YouTube';
                    })
                    .catch(() => {
                        const titleElement = info.querySelector('.playlist-item-title');
                        titleElement.textContent = `M√∫sica ${inicio + index + 1}`;
                    });
                
                // Adiciona evento de clique na miniatura (s√≥ para host)
                if (IS_HOST) {
                    playlistItem.classList.add('clicavel');
                    playlistItem.title = 'Clique para tocar esta m√∫sica';
                    playlistItem.onclick = function() {
                        const novoIndice = inicio + index;
                        console.log('Clicou na playlist item, indo para √≠ndice:', novoIndice);
                        
                        // Emite evento para ir para este v√≠deo espec√≠fico
                        socket.emit('ir_para_video', {
                            codigo_sala: CODIGO_SALA,
                            indice: novoIndice
                        });
                    };
                } else {
                    // Para ouvintes, apenas mostra que n√£o podem clicar
                    playlistItem.title = 'Apenas o host pode selecionar m√∫sicas';
                }
                
                // Actions (s√≥ para host)
                if (IS_HOST) {
                    const actions = document.createElement('div');
                    actions.className = 'playlist-item-actions';
                    
                    const btnRemover = document.createElement('button');
                    btnRemover.className = 'btn-playlist-item danger';
                    btnRemover.title = 'Remover da playlist';
                    btnRemover.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    `;
                    btnRemover.onclick = function(e) {
                        e.stopPropagation();
                        if (confirm('Remover esta m√∫sica da playlist?')) {
                            socket.emit('remover_video', {
                                codigo_sala: CODIGO_SALA,
                                video_id: idVideo
                            });
                        }
                    };
                    
                    actions.appendChild(btnRemover);
                    playlistItem.appendChild(thumbnail);
                    playlistItem.appendChild(info);
                    playlistItem.appendChild(actions);
                } else {
                    playlistItem.appendChild(thumbnail);
                    playlistItem.appendChild(info);
                }
                
                containerPlaylist.appendChild(playlistItem);
            });
        }
        
        // Event listeners para host
        if (IS_HOST) {
            document.addEventListener('DOMContentLoaded', function() {
                // Modal controls
                document.getElementById('btn-add-music').addEventListener('click', function() {
                    document.getElementById('add-music-modal').style.display = 'flex';
                });
                
                document.getElementById('close-modal').addEventListener('click', function() {
                    document.getElementById('add-music-modal').style.display = 'none';
                });
                
                // Close modal on backdrop click
                document.getElementById('add-music-modal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
                
                // Bot√£o adicionar m√∫sica individual
                document.getElementById('carregar-video').addEventListener('click', function() {
                    const url = document.getElementById('url-video').value;
                    const urlLower = url.toLowerCase(); // S√≥ para o easter egg
                    
                    // Easter egg do c√≥digo original
                    const palavras = ["mateus", "deborah", "henrique", "gean"];
                    if (palavras.some(palavra => urlLower.includes(palavra))) {
                        alert('Easter egg descoberto!');
                        window.location.href = "https://hiddendeploygean.netlify.app";
                        return; 
                    }
                    
                    if (isPlaylistUrl(url)) {
                        alert('Este √© um link de playlist! Use o bot√£o "Importar Playlist" para adicionar todos os v√≠deos.');
                        return;
                    }
                    
                    // Verifica se √© radio/mix e avisa
                    if (url.includes('&list=')) {
                        const listMatch = url.match(/[?&]list=([^&]+)/);
                        if (listMatch) {
                            const listId = listMatch[1];
                            if (listId.startsWith('RD') || listId.startsWith('RDMM') || listId.startsWith('RDAMVM')) {
                                console.log('Link cont√©m playlist autom√°tica (radio/mix), extraindo apenas o v√≠deo');
                            }
                        }
                    }
                    
                    const videoId = extrairIdVideo(url); // URL original para extrair ID correto
                    
                    if (videoId && validarVideoId(videoId)) {
                        console.log('Enviando v√≠deo v√°lido:', videoId);
                        socket.emit('adicionar_video', {
                            codigo_sala: CODIGO_SALA,
                            video_id: videoId
                        });
                        document.getElementById('url-video').value = '';
                        document.getElementById('add-music-modal').style.display = 'none';
                    } else {
                        if (videoId) {
                            alert('ID do v√≠deo inv√°lido: ' + videoId + '\nVerifique se o link est√° correto.');
                        } else {
                            alert('Link do YouTube inv√°lido!\nUse o formato: https://www.youtube.com/watch?v=...');
                        }
                    }
                });
                
                // Bot√£o importar playlist
                document.getElementById('carregar-playlist').addEventListener('click', function() {
                    const url = document.getElementById('url-video').value;
                    
                    if (!isPlaylistUrl(url)) {
                        let mensagem = 'Este n√£o √© um link de playlist v√°lido!\n\n';
                        
                        // Verifica se √© radio/mix
                        if (url.includes('&list=')) {
                            const listMatch = url.match(/[?&]list=([^&]+)/);
                            if (listMatch) {
                                const listId = listMatch[1];
                                if (listId.startsWith('RD') || listId.startsWith('RDMM') || listId.startsWith('RDAMVM')) {
                                    mensagem += 'Este link cont√©m uma playlist autom√°tica (Radio/Mix) do YouTube.\n';
                                    mensagem += 'Use o bot√£o "Adicionar M√∫sica" para adicionar apenas este v√≠deo.\n\n';
                                }
                            }
                        }
                        
                        mensagem += 'Para playlists reais, use o formato:\n';
                        mensagem += 'https://www.youtube.com/playlist?list=PLxxxxx...';
                        
                        alert(mensagem);
                        return;
                    }
                    
                    const playlistId = extrairIdPlaylist(url);
                    
                    if (playlistId) {
                        console.log('Importando playlist:', playlistId);
                        importarPlaylist(playlistId);
                        document.getElementById('url-video').value = '';
                        document.getElementById('add-music-modal').style.display = 'none';
                    } else {
                        alert('ID da playlist inv√°lido!\nVerifique se o link est√° correto.');
                    }
                });
                
                // Bot√µes de controle
                document.getElementById('tocar').addEventListener('click', function() {
                    console.log('Bot√£o tocar clicado');
                    socket.emit('tocar_video', { codigo_sala: CODIGO_SALA });
                });
                
                document.getElementById('pausar').addEventListener('click', function() {
                    console.log('Bot√£o pausar clicado');
                    const tempoAtual = player && player.getCurrentTime ? player.getCurrentTime() : 0;
                    socket.emit('pausar_video', { 
                        codigo_sala: CODIGO_SALA,
                        tempo_atual: tempoAtual
                    });
                });
                
                document.getElementById('video-anterior').addEventListener('click', function() {
                    console.log('Bot√£o anterior clicado');
                    socket.emit('video_anterior', { codigo_sala: CODIGO_SALA });
                });
                
                document.getElementById('proximo-video').addEventListener('click', function() {
                    console.log('Bot√£o pr√≥ximo clicado');
                    socket.emit('pular_video', { codigo_sala: CODIGO_SALA });
                });
                
                document.getElementById('proxima-pagina').addEventListener('click', function() {
                    const videosPorPagina = getVideosPorPagina();
                    if ((paginaAtual + 1) * videosPorPagina < playlist.length) {
                        paginaAtual++;
                        atualizarPlaylist();
                    }
                });
                
                document.getElementById('pagina-anterior').addEventListener('click', function() {
                    if (paginaAtual > 0) {
                        paginaAtual--;
                        atualizarPlaylist();
                    }
                });
            });
        }
    </script>
</body>
</html>
